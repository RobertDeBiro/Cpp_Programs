@startuml SystemInitializingState

!include ISystemState_SystemInitializing.puml

class OpContext {
  ==<i><color:DarkGreen>Controllers</color></i>==
  + adapter_ctrl : std::unique_ptr<AdapterController>
  + mobile_ctrl : std::unique_ptr<MobileController>
  + planner_ctrl : std::unique_ptr<PlannerController>
  + plc_ctrl : std::unique_ptr<PlcController>
  + power_ctrl : std::unique_ptr<PowerController>
  + robot_ctrl : std::unique_ptr<RobotController>
  __
  ==<i><color:DarkGreen>View Controllers</color></i>==
  + startup_view_ctrl : std::unique_ptr<StartupViewController>
  + context_view_ctrl : std::unique_ptr<ContextViewController>
}

' Include Controllers used
package Controllers {
!include ../../Controllers/AdapterController.puml
!include ../../Controllers/MobileController.puml
!include ../../Controllers/PlannerController.puml
!include ../../Controllers/PlcController.puml
!include ../../Controllers/PowerController.puml
!include ../../Controllers/RobotController.puml
}

' Include ViewControllers used
package ViewControllers {
!include ../../ViewControllers/StartupViewController.puml
!include ../../ViewControllers/ContextViewController.puml
}

package StartupStates {

class SystemInitializingState << (S,#FF7700) State >> {
  + OnEnter() : void
  + OnExit() : void
  __
  ==<i><color:DarkBlue>Connection Events (7)</color></i>==
  # OnAdapterConnected()
  # OnMobileConnected()
  # OnPlannerConnected()
  # OnPlcConnected()
  # OnPowerConnected()
  # OnRobotCoreConnected()
  # OnRobotLiveConnected()
  __
  ==<i><color:DarkBlue>PLC Safety & Robot (4)</color></i>==
  # OnPlcSafetyRunning()
  # OnPlcEStopsRestarted()
  # OnPlcRobotStarted()
  # OnPlcRobotStartFailed(error)
  __
  ==<i><color:DarkBlue>Mobile Events (21)</color></i>==
  # OnEnableReset()
  # OnMobileIdleLowered/Lifted()
  # OnMobilePlatformIdle()
  # OnHomingNeeded/Finished()
  # OnHomingController... (3)
  # OnLiftingController... (3)
  # OnJoystick... (3)
  # OnPoseController... (4)
  # OnEnableWarning()
  __
  ==<i><color:DarkBlue>View Events (1)</color></i>==
  # OnContextButtonShutdownClicked()
  __
  ==<i><color:DarkBlue>Internal State</color></i>==
  - _safety_started : bool
  - _robot_started : bool
  __
  <i><color:Gray>Initializes all controllers and connections</color></i>
  <i><color:Gray>Waits for all systems to connect</color></i>
  <i><color:Gray>Transitions to MOBILE_HOMING_STATE</color></i>
}

}

' Relationships
SystemInitializingState -up--|> ISystemState

' Uses OpContext (positioned left)
SystemInitializingState -left-> OpContext : uses

' OpContext contains Controllers
OpContext o-down- AdapterController : contains
OpContext o-down- MobileController : contains
OpContext o-down- PlannerController : contains
OpContext o-down- PlcController : contains
OpContext o-down- PowerController : contains
OpContext o-down- RobotController : contains

' OpContext contains ViewControllers
OpContext o-down- StartupViewController : contains
OpContext o-down- ContextViewController : contains

note right of SystemInitializingState
  **System Initialization State**
  
  **OnEnter:**
  - Activates StartupViewController
  - Starts all controller connections:
    • adapter_ctrl->StartAccepting()
    • mobile_ctrl->StartConnecting()
    • planner_ctrl->StartAccepting()
    • plc_ctrl->StartConnecting()
    • power_ctrl->StartAccepting()
    • robot_ctrl->StartAccepting()
  - Shows initializing popup
  - Enables PLC system check
  - Starts PLC safety
  
  **Connection Flow:**
  1. Wait for all connections
  2. PLC connects → Start safety
  3. Safety running → Restart E-Stops
  4. E-Stops restarted → Start robot
  5. Robot started → Check all connected
  6. All ready → MOBILE_HOMING_STATE
  
  **Overrides: 34 methods**
  - 7 connection events
  - 4 PLC/safety events
  - 21 mobile platform events
  - 1 view event
  - 1 helper method
end note

@enduml
