@startuml MobileHomingState

!include ISystemState_MobileHoming.puml

class OpContext {
  ==<i><color:DarkGreen>Controllers</color></i>==
  + mobile_ctrl : std::unique_ptr<MobileController>
  + robot_ctrl : std::unique_ptr<RobotController>
  __
  ==<i><color:DarkGreen>View Controllers</color></i>==
  + startup_view_ctrl : std::unique_ptr<StartupViewController>
  + context_view_ctrl : std::unique_ptr<ContextViewController>
}

' Include Controllers used
package Controllers {
!include ../../Controllers/MobileController.puml
!include ../../Controllers/RobotController.puml
}

' Include ViewControllers used
package ViewControllers {
!include ../../ViewControllers/StartupViewController.puml
!include ../../ViewControllers/ContextViewController.puml
}

package StartupStates {

class MobileHomingState << (S,#FF7700) State >> {
  + OnEnter() : void
  + OnExit() : void
  __
  ==<i><color:DarkBlue>Mobile Events (2)</color></i>==
  # OnHomingFinished()
  # OnHomingCanceled()
  __
  ==<i><color:DarkBlue>View Events (1)</color></i>==
  # OnContextButtonShutdownClicked()
  __
  ==<i><color:DarkBlue>Internal State</color></i>==
  - _homing_canceled : bool
  __
  <i><color:Gray>Handles mobile platform homing process</color></i>
  <i><color:Gray>Transitions to SYSTEM_CHECK_STATE</color></i>
}

}

' Relationships
MobileHomingState -up--|> ISystemState

' Uses OpContext (positioned left)
MobileHomingState -left-> OpContext : uses

' OpContext contains Controllers
OpContext o-down- MobileController : contains
OpContext o-down- RobotController : contains

' OpContext contains ViewControllers
OpContext o-down- StartupViewController : contains
OpContext o-down- ContextViewController : contains

note right of MobileHomingState
  **Mobile Platform Homing State**
  
  **OnEnter:**
  - Activates StartupViewController
  - Refreshes mobile state
  - Handles different mobile states:
    • HOMING_NEEDED → Show homing popup
    • IsHoming() → Stop homing
    • IDLE_LOWERED → Enable lift if at driving position
    • IDLE → Enable lift/lower if at driving position
  - Makes start check button visible
  
  **Homing Flow:**
  1. Check if homing needed
  2. If homing → wait for completion
  3. OnHomingFinished() or OnHomingCanceled()
  4. Transition to SYSTEM_CHECK_STATE
  
  **Robot Position Check:**
  - Verifies current joints at DRIVING_ROTS
  - Enables lift/lower controls accordingly
  
  **Overrides: 5 methods**
  - 2 mobile events (homing)
  - 1 view event (shutdown)
  - 1 helper method
end note

@enduml
